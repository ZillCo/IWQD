<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IoT Water Quality Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  <style>
    /* [Your CSS here – unchanged for brevity, same as in your original post] */
  </style>
</head>
<body>
  <!-- Login Box -->
  <div class="login-box" id="loginBox">
    <h3>Sign In With Google</h3>
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLIENT_ID"
         data-callback="handleGoogleLogin"></div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <header>
      <h1>IoT Water Quality Monitoring Dashboard</h1>
      <div>
        <button class="menu-button" onclick="toggleMenu()">☰ Menu</button>
        <div id="menuPanel" class="menu-panel">
          <button onclick="toggleDarkMode()">🌙 Toggle Dark Mode</button><br>
          <button onclick="toggleGraphType()">📊 Switch Chart Type</button><br>
          <button onclick="logout()">🔓 Logout</button>
        </div>
      </div>
    </header>

    <p>Welcome, <strong id="userDisplay"></strong></p>

    <!-- My Report -->
    <div class="report-box">
      <h3>My Report</h3>
      <ul id="summaryStats">
        <li><strong>Average pH:</strong> <span id="avgPh">-</span></li>
        <li><strong>Average Temp (°C):</strong> <span id="avgTemp">-</span></li>
        <li><strong>Average Turbidity:</strong> <span id="avgTurb">-</span></li>
        <li><strong>Average TDS:</strong> <span id="avgTds">-</span></li>
        <li><strong>Average DO:</strong> <span id="avgDo">-</span></li>
      </ul>
    </div>

    <!-- Charts Section -->
    <div class="sensor-box"><h3>pH Level</h3><canvas id="phChart"></canvas>Status: <span id="phStatus">Loading...</span></div>
    <div class="sensor-box"><h3>Temperature (°C)</h3><canvas id="tempChart"></canvas>Status: <span id="tempStatus">Loading...</span></div>
    <div class="sensor-box"><h3>Turbidity (NTU)</h3><canvas id="turbChart"></canvas>Status: <span id="turbStatus">Loading...</span></div>
    <div class="sensor-box"><h3>Total Dissolved Solids (mg/L)</h3><canvas id="tdsChart"></canvas>Status: <span id="tdsStatus">Loading...</span></div>
    <div class="sensor-box"><h3>Dissolved Oxygen (mg/L)</h3><canvas id="doChart"></canvas>Status: <span id="doStatus">Loading...</span></div>

    <!-- History Section -->
    <div class="sensor-box">
      <h3>History</h3>
      <button onclick="loadHistory()">View History</button>
      <ul id="historyList"></ul>
    </div>
  </div>

<script>
  let currentUser = null;
  let chartType = 'line';
  let darkMode = false;

  const endpoints = [
    { pin: "v1", chartId: "phChart", statusId: "phStatus", label: "pH", safe: [6.5, 8.5], maxY: 14 },
    { pin: "v2", chartId: "tempChart", statusId: "tempStatus", label: "Temp (°C)", safe: [20, 25.5], maxY: 40 },
    { pin: "v3", chartId: "turbChart", statusId: "turbStatus", label: "Turbidity", safe: [0, 1.5], maxY: 5 },
    { pin: "v4", chartId: "tdsChart", statusId: "tdsStatus", label: "TDS", safe: [0, 500], maxY: 1000 },
    { pin: "v5", chartId: "doChart", statusId: "doStatus", label: "DO", safe: [6.5, 8], maxY: 14 },
  ];

  const charts = {};
  const averages = { v1: [], v2: [], v3: [], v4: [], v5: [] };

  endpoints.forEach(sensor => {
    const ctx = document.getElementById(sensor.chartId).getContext("2d");
    charts[sensor.pin] = new Chart(ctx, {
      type: chartType,
      data: { labels: [], datasets: [{ label: sensor.label, data: [], borderColor: "blue", fill: false }] },
      options: { scales: { y: { min: 0, max: sensor.maxY } } }
    });
  });

  function handleGoogleLogin(response) {
    const data = jwt_decode(response.credential);
    initDashboard(data.email);
  }

  function initDashboard(user) {
    currentUser = user;
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("userDisplay").textContent = user;
    updateCharts();
    setInterval(updateCharts, 10000);
  }

  function toggleMenu() {
    document.getElementById("menuPanel").classList.toggle("active");
  }

  function toggleDarkMode() {
    darkMode = !darkMode;
    document.body.classList.toggle("dark-mode");
  }

  function toggleGraphType() {
    chartType = chartType === 'line' ? 'bar' : 'line';
    Object.values(charts).forEach(chart => {
      chart.config.type = chartType;
      chart.update();
    });
  }

  function logout() {
    currentUser = null;
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("loginBox").classList.remove("hidden");
  }

  async function fetchSensor(pin, chart, statusEl, safeRange) {
    try {
      const res = await fetch(`http://localhost:5000/api/latest/${pin}?user=${currentUser}`);
      const { value, timestamp } = await res.json();
      const now = new Date(timestamp).toLocaleTimeString();

      if (chart.data.labels.length > 10) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }

      chart.data.labels.push(now);
      chart.data.datasets[0].data.push(value);
      chart.update();

      averages[pin].push(value);
      if (averages[pin].length > 20) averages[pin].shift();

      const status = value >= safeRange[0] && value <= safeRange[1] ? "Safe ✅" : "Unsafe ⚠️";
      const color = value >= safeRange[0] && value <= safeRange[1] ? "green" : "red";

      statusEl.textContent = status;
      statusEl.style.color = color;

      updateReport();
    } catch (err) {
      statusEl.textContent = "Error ❌";
      statusEl.style.color = "gray";
    }
  }

  function updateCharts() {
    endpoints.forEach(({ pin, chartId, statusId, safe }) => {
      fetchSensor(pin, charts[pin], document.getElementById(statusId), safe);
    });
  }

  function updateReport() {
    document.getElementById("avgPh").textContent = average(averages.v1).toFixed(2);
    document.getElementById("avgTemp").textContent = average(averages.v2).toFixed(2);
    document.getElementById("avgTurb").textContent = average(averages.v3).toFixed(2);
    document.getElementById("avgTds").textContent = average(averages.v4).toFixed(2);
    document.getElementById("avgDo").textContent = average(averages.v5).toFixed(2);
  }

  function average(arr) {
    if (arr.length === 0) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }

  async function loadHistory() {
    const res = await fetch(`http://localhost:5000/api/history?user=${currentUser}`);
    const history = await res.json();
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    history.forEach(entry => {
      const li = document.createElement("li");
      li.textContent = `${new Date(entry.timestamp).toLocaleString()} — ${entry.parameter || entry.pin}: ${entry.value}`;
      list.appendChild(li);
    });
  }
</script>
</body>
</html>
