<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IoT Water Quality Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background: #f7f7f7; padding: 2rem; }
    h1 { color: #0066cc; }
    .sensor-box { background: white; padding: 1rem; border-radius: 12px; margin-bottom: 2rem; }
    canvas { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>IoT Water Quality Dashboard</h1>

  <div class="sensor-box">
    <h3>pH Level</h3>
    <canvas id="phChart"></canvas>
    Status: <span id="phStatus">Loading...</span>
  </div>

  <div class="sensor-box">
    <h3>Temperature (°C)</h3>
    <canvas id="tempChart"></canvas>
    Status: <span id="tempStatus">Loading...</span>
  </div>

  <div class="sensor-box">
    <h3>Turbidity (NTU)</h3>
    <canvas id="turbChart"></canvas>
    Status: <span id="turbStatus">Loading...</span>
  </div>

  <div class="sensor-box">
    <h3>Total Dissolved Solids (mg/L)</h3>
    <canvas id="tdsChart"></canvas>
    Status: <span id="tdsStatus">Loading...</span>
  </div>

  <div class="sensor-box">
    <h3>Dissolved Oxygen (mg/L)</h3>
    <canvas id="doChart"></canvas>
    Status: <span id="doStatus">Loading...</span>
  </div>

  <script>
    const endpoints = [
      { pin: "v1", chartId: "phChart", statusId: "phStatus", label: "pH", safe: [6.5, 8.5], maxY: 14 },
      { pin: "v2", chartId: "tempChart", statusId: "tempStatus", label: "Temp (°C)", safe: [20, 25.5], maxY: 40 },
      { pin: "v3", chartId: "turbChart", statusId: "turbStatus", label: "Turbidity (NTU)", safe: [0, 1.5], maxY: 5 },
      { pin: "v4", chartId: "tdsChart", statusId: "tdsStatus", label: "TDS (mg/L)", safe: [0, 500], maxY: 1000 },
      { pin: "v5", chartId: "doChart", statusId: "doStatus", label: "DO (mg/L)", safe: [6.5, 8], maxY: 14 },
    ];

    const charts = {};

    endpoints.forEach(sensor => {
      const ctx = document.getElementById(sensor.chartId).getContext("2d");
      charts[sensor.pin] = new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [{ label: sensor.label, data: [], borderColor: "blue", fill: false }] },
        options: { scales: { y: { min: 0, max: sensor.maxY } } }
      });
    });

    async function fetchSensor(pin, chart, statusEl, safeRange) {
      try {
        const res = await fetch(`http://localhost:3000/api/latest/${pin}`);
        const { value } = await res.json();
        const val = parseFloat(value);
        const now = new Date().toLocaleTimeString();

        if (chart.data.labels.length > 10) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(val);
        chart.update();

        statusEl.textContent = val >= safeRange[0] && val <= safeRange[1] ? "Safe ✅" : "Unsafe ⚠️";
        statusEl.style.color = val >= safeRange[0] && val <= safeRange[1] ? "green" : "red";

      } catch (err) {
        statusEl.textContent = "Error ❌";
        statusEl.style.color = "gray";
      }
    }

    function updateCharts() {
      endpoints.forEach(({ pin, chartId, statusId, safe }) => {
        fetchSensor(pin, charts[pin], document.getElementById(statusId), safe);
      });
    }

    updateCharts();
    setInterval(updateCharts, 10000);
  </script>
</body>
</html>
