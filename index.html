<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IoT Water Quality Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  <style>
    :root {
      --light-bg: #ffffff;
      --light-text: #000000;
      --dark-bg: #1e1e2f; /* Softer dark background */
      --dark-text: #e0e0e0;
      
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;   /* vertical centering */
      justify-content: center; /* horizontal centering */
      transition: background-color 0.3s, color 0.3s;
      height: 100vh;
      color: var(--light-text);
    }
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
      /* Force these text areas to stay black even in dark mode */
    li, span, ul {
      color: black !important;
    }
   /* Header stays the same in dark mode */
    header {
      background-color: #0066cc;
      transition: background-color 0.3s;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    h1 {
      margin: 0;
    }
    body.dark-mode header {
      background-color: #2b2b40; /* A smooth deep blue-gray */
    }
    header h1, header p {
      margin: 0.3rem 0;
      line-height: 1.4;
    }    
    .menu-panel button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
      padding: 5px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode .menu-button,
    body.dark-mode .menu-panel button {
      background-color: #333;
      color: #f5f5f5;
    }
   /* Adjust menu button for dark mode */
    .menu-button {
      font-size: 20px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      transition: background 0.3s, color 0.3s;
    }
    /* Improved styling for the login box */
    .login-box {
      background-color: white;
      width: 300px;
      height: 500px; /* vertical rectangle */
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      display: flex;
      max-width: 350px;
      width: 90%;
      margin: auto;
      flex-direction: column;
      justify-content: center;
      font-weight: 600;
      color: #333;
      gap: 30px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode .login-box {
      background-color: #2a2a3d;
      color: #e0e0e0;
      box-shadow: 0 10px 25px rgba(255,255,255,0.1);
    }
    .login-box h3 {
      font-size: 1.8rem;
      margin: 0;
      font-weight: 700;
      color: inherit;
    }

    /* Menu panel style */
    .menu-panel {
      background: white;
      border: 1px solid #ccc;
      position: absolute;
      top: 60px;
      right: 10px;
      padding: 10px;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      transition: background 0.3s, color 0.3s;
    }
    .menu-panel.active {
      display: block;
    }
    /* Card-like boxes */
    .sensor-box, .report-box {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem auto;
      max-width: 700px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: background 0.3s, color 0.3s;
      color: black !important;
    }
    canvas {
      margin-bottom: 1rem;
      max-width: 100%;
    }
    .hidden {
      display: none;
    }
    .dashboard {
      display: flex;
      padding: 20px;
      gap: 20px;
    }
    .left-panel {
      flex: 1;
    }
    .right-panel {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chart {
      height: 120px;
      background-color: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    body.dark-mode .menu-panel {
      background-color: #2e2e40;
      color: white;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem;
    }
    
     .container1 {
       justify-content: center;
       align-items: center;
       background-color: #1e1e1e;
       border-radius: 10px;
       box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
       width: 100%;
       max-width: 400px;
       display: flex;
       align-items: center;
    }
    .g-recaptcha {
      margin: 1.5rem 0;
    }

    #history {
      order: 1;
      flex: 1;
      min-width: 300px;
    }
    #sensors {
      order: 2;
      flex: 1;
      min-width: 300px;
    }
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      #history, #sensors {
        order: unset;
      }
    }
  </style>
</head>

<body>
    <div class="container1">
      <div class="login-box" id="loginBox">
        <h3>Sign In With Google</h3>
        <!-- reCAPTCHA widget -->
        <div class="g-recaptcha" data-sitekey="6LdXQEkrAAAAAPOtTK0_X9QdLl68ckIFrYTHPArg" data-callback="onCaptchaSuccess"></div>
        
        <!-- Google sign-in button, initially hidden -->
        <div id="googleSignInBtn" style="margin-top: 30px; display:none;">
          <div id="g_id_onload"
            data-client_id="1082316602730-lasg1o8e0ub19u2dduv98i1il8qkl5u5.apps.googleusercontent.com"
            data-callback="handleGoogleLogin"
            data-auto_prompt="false">
          </div>
          <div class="g_id_signin" data-type="standard"></div>
        </div>
    </div>
  </div>

  <div id="dashboard" class="hidden">
    <header>
      <h1>IoT Water Quality Monitoring Dashboard</h1>
      <br><p>Welcome,<strong id="userDisplay"></strong></p>
      <div>
        <button class="menu-button" onclick="toggleMenu()">☰ Menu</button>
        <div id="menuPanel" class="menu-panel">
          <button onclick="toggleDarkMode()">🌙 Toggle Dark Mode</button><br>
          <button onclick="toggleGraphType()">📊 Switch Chart Type</button><br>
          <button onclick="logout()">🔓 Logout</button>
        </div>
      </div>
    </header>

    <div class="report-box">
      <h3>My Report</h3>
      <ul id="summaryStats">
        <li><strong>Average pH:</strong> <span id="avgPh">-</span></li>
        <li><strong>Average Temp (°C):</strong> <span id="avgTemp">-</span></li>
        <li><strong>Average Turbidity:</strong> <span id="avgTurb">-</span></li>
        <li><strong>Average TDS:</strong> <span id="avgTds">-</span></li>
        <li><strong>Average DO:</strong> <span id="avgDo">-</span></li>
      </ul>
    </div>

    <div class="container">
      <!-- Move your history section here -->
      <div id="history">
        <div class="sensor-box">
          <h3>History</h3>
          <button onclick="loadHistory()">View History</button>
          <ul id="historyList"></ul>
        </div>
      </div>
      
      <!-- Move your sensors section here -->
      <div id="sensors">
        <div class="sensor-box">
          <h3>pH Level</h3>
          <canvas id="phChart"></canvas>
          Status: <span id="phStatus">Loading...</span>
        </div>
        
        <div class="sensor-box">
          <h3>Temperature (°C)</h3>
          <canvas id="tempChart"></canvas>
          Status: <span id="tempStatus">Loading...</span>
        </div>
        
        <div class="sensor-box">
          <h3>Turbidity (NTU)</h3>
          <canvas id="turbChart"></canvas>
          Status: <span id="turbStatus">Loading...</span>
        </div>
        
        <div class="sensor-box">
          <h3>Total Dissolved Solids (mg/L)</h3>
          <canvas id="tdsChart"></canvas>
          Status: <span id="tdsStatus">Loading...</span>
        </div>
        
        <div class="sensor-box">
          <h3>Dissolved Oxygen (mg/L)</h3>
          <canvas id="doChart"></canvas>
          Status: <span id="doStatus">Loading...</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let currentUser = null;
    let darkMode = false;
    let chartType = 'line';

    const endpoints = [
      { pin: "v1", chartId: "phChart", statusId: "phStatus", label: "pH", safe: [6.5, 8.5], maxY: 14 },
      { pin: "v2", chartId: "tempChart", statusId: "tempStatus", label: "Temp (°C)", safe: [20, 25.5], maxY: 40 },
      { pin: "v3", chartId: "turbChart", statusId: "turbStatus", label: "Turbidity", safe: [0, 1.5], maxY: 5 },
      { pin: "v4", chartId: "tdsChart", statusId: "tdsStatus", label: "TDS", safe: [0, 500], maxY: 1000 },
      { pin: "v5", chartId: "doChart", statusId: "doStatus", label: "DO", safe: [6.5, 8], maxY: 14 }
    ];

    const charts = {};
    const averages = { v1: [], v2: [], v3: [], v4: [], v5: [] };

    function onCaptchaSuccess() {
    document.getElementById("googleSignInBtn").style.display = "block";
  }
    async function handleGoogleLogin(response) {
    const captchaResponse = grecaptcha.getResponse();
    if (!captchaResponse) {
      alert("Please complete the CAPTCHA first.");
      return;
    }
    const res = await fetch("/api/auth/google", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        idToken: response.credential,
        captcha: captchaResponse
      })
    });
      const data = await res.json();
    if (data.success) {
      window.location.href = "/dashboard";
    } else {
      alert(data.message || "Login failed");
    }
  }
    function handleGoogleLogin(response) {
      const data = jwt_decode(response.credential);
      const user = data.email;
      initDashboard(user);
    }

    function initDashboard(user) {
      currentUser = user;
      document.querySelector("button[onclick='loadHistory()']").disabled = !currentUser;
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("userDisplay").textContent = user;
      updateCharts();
      setInterval(updateCharts, 10000);
    }

    function toggleMenu() {
      document.getElementById("menuPanel").classList.toggle("active");
    }
    function applyChartTheme() {
      Object.values(charts).forEach(chart => {
        chart.options.plugins = {
          legend: { labels: { color: darkMode ? 'white' : 'black' } }
        };
        chart.options.scales.x.ticks.color = darkMode ? 'white' : 'black';
        chart.options.scales.y.ticks.color = darkMode ? 'white' : 'black';
        chart.update();
      });
    }
    
    function toggleDarkMode() {
      applyChartTheme();
      darkMode = !darkMode;
      document.body.classList.toggle('dark-mode');
      // Optional: change chart line colors for better visibility
      Object.values(charts).forEach(chart => {
        chart.data.datasets[0].borderColor = darkMode ? "lightblue" : "blue";
        chart.update();
      });
    }

    function toggleGraphType() {
      chartType = chartType === 'line' ? 'bar' : 'line';
      endpoints.forEach(sensor => {
        const chart = charts[sensor.pin];
        chart.config.type = chartType;
        chart.update();
      });
    }

    function logout() {
      currentUser = null;
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("loginBox").classList.remove("hidden");
    }

    endpoints.forEach(sensor => {
      const ctx = document.getElementById(sensor.chartId).getContext("2d");
      charts[sensor.pin] = new Chart(ctx, {
        type: chartType,
        data: { labels: [], datasets: [{ label: sensor.label, data: [], borderColor: "blue", fill: false }] },
        options: { scales: { y: { min: 0, max: sensor.maxY } } }
      });
    });

    async function fetchSensor(pin, chart, statusEl, safeRange) {
      try {
        const res = await fetch(`https://iwqd.onrender.com/${pin}?user=${currentUser}`);
        const { value } = await res.json();
        const val = parseFloat(value);
        const now = new Date().toLocaleTimeString();

        if (chart.data.labels.length > 10) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(val);
        chart.update();

        averages[pin].push(val);
        if (averages[pin].length > 20) averages[pin].shift();

        statusEl.textContent = val >= safeRange[0] && val <= safeRange[1] ? "Safe ✅" : "Unsafe ⚠️";
        statusEl.style.color = val >= safeRange[0] && val <= safeRange[1] ? "green" : "red";
      } catch (err) {
        statusEl.textContent = "Error ❌";
        statusEl.style.color = "gray";
      }
    }
    async function updateCharts() {
      for (const sensor of endpoints) {
        const chart = charts[sensor.pin];
        const statusEl = document.getElementById(sensor.statusId);
        await fetchSensor(sensor.pin, chart, statusEl, sensor.safe);
      }
      updateSummaryStats();
    }
    function updateSummaryStats() {
      document.getElementById("avgPh").textContent = avg(averages.v1).toFixed(2);
      document.getElementById("avgTemp").textContent = avg(averages.v2).toFixed(2);
      document.getElementById("avgTurb").textContent = avg(averages.v3).toFixed(2);
      document.getElementById("avgTds").textContent = avg(averages.v4).toFixed(2);
      document.getElementById("avgDo").textContent = avg(averages.v5).toFixed(2);
    }
    function avg(arr) {
      return arr.reduce((a, b) => a + b, 0) / (arr.length || 1);
    }
    function updateCharts() {
      endpoints.forEach(({ pin, chartId, statusId, safe }) => {
        fetchSensor(pin, charts[pin], document.getElementById(statusId), safe);
      });
    }
    setInterval(() => {
      updateCharts();
      updateSummaryStats();
    }, 10000);
    
    async function loadHistory() {
      try {
        const res = await fetch(`/api/history?user=${currentUser}`);
        const data = await res.json();
        const list = document.getElementById("historyList");
        list.innerHTML = "";

        data.forEach(item => {
          const li = document.createElement("li");
          li.textContent = `Time: ${item.time}, pH: ${item.v1}, Temp: ${item.v2}, Turb: ${item.v3}, TDS: ${item.v4}, DO: ${item.v5}`;
          list.appendChild(li);
        });
      } catch (err) {
        alert("Failed to load history.");
      }
    }
    function onCaptchaSuccess() {
  // Show the Google Sign-In button only after captcha is solved
  document.getElementById('googleSignInBtn').style.display = 'block';
}
  </script>
</body>
</html>
